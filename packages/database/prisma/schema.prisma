generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   // Disimpan terenkripsi (bcrypt/argon2)
  name          String   // Nama Toko (Contoh: "Nasi Goreng Pak Bagus")
  walletAddress String?  // Alamat wallet pribadi merchant (opsional untuk MVP)
  bankName      String?  // Contoh: BCA
  bankAccount   String?  // Contoh: 1234567890
  bankHolder    String?
  
  // Saldo Virtual (Rupiah)
  balanceIDR    Decimal  @default(0) @db.Decimal(18, 2)

  transactions  Transaction[]
  payouts       Payout[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("merchants")
}

model Payout {
  id            String       @id @default(uuid())
  
  merchantId    String
  merchant      Merchant     @relation(fields: [merchantId], references: [id])
  
  amountRequested Decimal    @db.Decimal(18, 2) 
  feeAdmin        Decimal    @db.Decimal(18, 2) 
  amountFinal     Decimal    @db.Decimal(18, 2)
  
  toBankName      String
  toBankAccount   String
  toBankHolder    String

  status          PayoutStatus @default(REQUESTED)
  
  proofImage      String?
  referenceNo     String?
  rejectionReason String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("payouts")
}

model Transaction {
  id              String            @id @default(uuid())
  
  // Relasi
  merchantId      String
  merchant        Merchant          @relation(fields: [merchantId], references: [id])

  // Detail Nominal - Invoice
  amountInvoice   Decimal           @db.Decimal(18, 2) // Jumlah tagihan dalam IDR (Rp 50.000)
  amountUSDT      Decimal           @db.Decimal(18, 6) // Jumlah tagihan dalam USDT (termasuk spread)
  exchangeRate    Decimal           @db.Decimal(18, 2) // Exchange rate saat transaksi (IDR per USDT)
  
  // Detail Nominal - Payment Received
  amountReceivedUSDT Decimal        @default(0) @db.Decimal(18, 6) // Jumlah USDT yang diterima
  amountReceivedIdr   Decimal       @default(0) @db.Decimal(18, 2) // Jumlah IDR yang diterima (amountReceivedUSDT * exchangeRate)
  
  // Detail Nominal - Breakdown
  tipIdr          Decimal           @default(0) @db.Decimal(18, 2) // Tip jika overpaid (dalam IDR)
  feeApp          Decimal           @default(0) @db.Decimal(18, 2) // Fee aplikasi (1.5% dari amountInvoice)
  
  paymentAddress  String            @unique            // Alamat Vault (Hasil CREATE2)
  salt            String?           @unique            // PENGGANTI Private Key (UUID)
  isDeployed      Boolean           @default(false)    // Status apakah contract sudah dideploy
  gelatoTaskId    String?                              // ID Task Relayer
  
  // Detail Blockchain
  network         String            @default("MANTLE") // Chain: MANTLE, BSC, TRON
  txHash          String?                              // Hash transaksi pembayaran user
  
  status          TransactionStatus @default(PENDING)
  
  // Waktu
  expiresAt       DateTime          // Batas waktu bayar
  confirmedAt     DateTime?         // Waktu user sukses bayar
  settledAt       DateTime?         // Waktu masuk saldo merchant
  sweptAt         DateTime?         // Waktu sukses disapu ke Cold Wallet

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([paymentAddress])
  @@map("transactions")
}

model RateHistory {
  id        Int      @id @default(autoincrement())
  pair      String   @default("USDT/IDR")
  rate      Decimal  @db.Decimal(18, 2)
  source    String   // Sumber API (misal: "Binance", "CoinGecko")
  timestamp DateTime @default(now())

  @@map("rates")
}

enum TransactionStatus {
  PENDING         
  DETECTED        
  PARTIALLY_PAID  
  CONFIRMED       
  PAID            
  OVERPAID        
  EXPIRED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  REQUESTED   
  COMPLETED
  REJECTED    
  FAILED
}