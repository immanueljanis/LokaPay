generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum untuk status transaksi (State Machine)
enum TransactionStatus {
  PENDING         // Invoice dibuat, menunggu pembayaran
  DETECTED        // Pembayaran terdeteksi di mempool/blockchain (belum confirm)
  PARTIALLY_PAID  // Kurang bayar, boleh tambah lagi
  CONFIRMED       // Sudah confirmed di blockchain (Sukses sisi Crypto)
  PAID            // Sudah dikonversi ke IDR & masuk saldo Merchant (Sukses Total)
  OVERPAID        // Lebih bayar
  EXPIRED         // User telat bayar
  FAILED          // Gagal (kurang bayar / error network)
  REFUNDED        // Dana dikembalikan (manual case)
}

model Merchant {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   // Disimpan terenkripsi (bcrypt/argon2)
  name          String   // Nama Toko (Contoh: "Nasi Goreng Pak Bagus")
  walletAddress String?  // Alamat wallet pribadi merchant (opsional untuk MVP)
  bankName      String?  // Contoh: BCA
  bankAccount   String?  // Contoh: 1234567890
  
  // Saldo Virtual (Rupiah)
  balanceIDR    Decimal  @default(0) @db.Decimal(18, 2)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions  Transaction[]

  @@map("merchants")
}

model Transaction {
  id              String            @id @default(uuid())
  
  // Relasi
  merchantId      String
  merchant        Merchant          @relation(fields: [merchantId], references: [id])

  // Detail Nominal
  amountIDR       Decimal           @db.Decimal(18, 2) // Tagihan asli: Rp 50.000
  amountUSDT      Decimal           @db.Decimal(18, 6) // Tagihan Crypto: 3.40
  amountReceived  Decimal           @default(0) @db.Decimal(18, 6) // Yang sudah masuk
  exchangeRate    Decimal           @db.Decimal(18, 2) // Rate: Rp 15.800

  // Logic Smart Vault (V2)
  paymentAddress  String            @unique            // Alamat Vault (Hasil CREATE2)
  salt            String?           @unique            // PENGGANTI Private Key (UUID)
  isDeployed      Boolean           @default(false)    // Status apakah contract sudah dideploy
  gelatoTaskId    String?                              // ID Task Relayer
  
  // Detail Blockchain
  network         String            @default("MANTLE") // Chain: MANTLE, BSC, TRON
  txHash          String?                              // Hash transaksi pembayaran user
  
  status          TransactionStatus @default(PENDING)
  
  // Waktu
  expiresAt       DateTime          // Batas waktu bayar
  confirmedAt     DateTime?         // Waktu user sukses bayar
  settledAt       DateTime?         // Waktu masuk saldo merchant
  sweptAt         DateTime?         // Waktu sukses disapu ke Cold Wallet

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([paymentAddress])
  @@map("transactions")
}

model RateHistory {
  id        Int      @id @default(autoincrement())
  pair      String   @default("USDT/IDR")
  rate      Decimal  @db.Decimal(18, 2)
  source    String   // Sumber API (misal: "Binance", "CoinGecko")
  timestamp DateTime @default(now())

  @@map("rates")
}