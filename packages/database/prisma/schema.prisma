generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   
  name          String   
  role          String   @default("MERCHANT")
  walletAddress String?  
  bankName      String?  
  bankAccount   String?  
  bankHolder    String?
  
  balanceIDR    Decimal  @default(0) @db.Decimal(18, 2)

  transactions  Transaction[]
  payouts       Payout[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("merchants")
}

model Payout {
  id            String       @id @default(uuid())
  
  merchantId    String
  merchant      Merchant     @relation(fields: [merchantId], references: [id])
  
  amountRequested Decimal    @db.Decimal(18, 2) 
  feeAdmin        Decimal    @db.Decimal(18, 2) 
  amountFinal     Decimal    @db.Decimal(18, 2)
  
  toBankName      String
  toBankAccount   String
  toBankHolder    String

  status          PayoutStatus @default(REQUESTED)
  
  proofImage      String?
  referenceNo     String?
  rejectionReason String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("payouts")
}

model Transaction {
  id              String            @id @default(uuid())
  
  // Relasi
  merchantId      String
  merchant        Merchant          @relation(fields: [merchantId], references: [id])

  // Detail Nominal - Invoice
  amountInvoice   Decimal           @db.Decimal(18, 2)
  amountUSD       Decimal           @default(0) @db.Decimal(18, 6)
  exchangeRate    Decimal           @db.Decimal(18, 2)
  
  // Detail Nominal - Payment Received
  amountReceivedUSD Decimal         @default(0) @db.Decimal(18, 6)
  amountReceivedIdr   Decimal       @default(0) @db.Decimal(18, 2)
  
  // Detail Nominal - Breakdown
  tipIdr          Decimal           @default(0) @db.Decimal(18, 2)
  feeApp          Decimal           @default(0) @db.Decimal(18, 2)
  
  paymentAddress  String            @unique            
  salt            String?           @unique            
  shortCode       String?           @unique            
  isDeployed      Boolean           @default(false)    
  gelatoTaskId    String?
  
  // Detail Blockchain
  network         String
  txHash          String?
  
  status          TransactionStatus @default(PENDING)
  
  // Waktu
  expiresAt       DateTime         
  confirmedAt     DateTime?        
  settledAt       DateTime?        
  sweptAt         DateTime?        

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([paymentAddress])
  @@index([shortCode])
  @@map("transactions")
}

model RateHistory {
  id        Int      @id @default(autoincrement())
  pair      String   @default("USDC/IDR")
  rate      Decimal  @db.Decimal(18, 2)
  source    String  
  timestamp DateTime @default(now())

  @@map("rates")
}

enum TransactionStatus {
  PENDING         
  DETECTED        
  PARTIALLY_PAID  
  CONFIRMED       
  PAID            
  OVERPAID        
  EXPIRED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  REQUESTED   
  COMPLETED
  REJECTED    
  FAILED
}